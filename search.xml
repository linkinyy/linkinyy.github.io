<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>突发！incaseformat蠕虫病毒来袭！！！</title>
    <url>/2021/01/16/incaseformat/</url>
    <content><![CDATA[<p>2021年1月13日，不断有客户反馈电脑被清除磁盘数据，涉及的范围有政府，医疗，教育等行业，一时间在各个群里传的沸沸扬扬。经过重重检查，最终锁定在了名为incaseformat的病毒身上。</p>
<a id="more"></a>
<p><img src="/images/incaseformat/1.incaseformat.png" alt="网传信息"></p>
<h2 id="病毒来源"><a href="#病毒来源" class="headerlink" title="病毒来源"></a>病毒来源</h2><p>该病毒最初在09年左右开始出现，并通过U盘或共享文件夹等形式传播。<br><img src="/images/incaseformat/incaseformat%E5%87%BA%E7%8E%B0%E6%97%B6%E9%97%B4.png" alt="出现时间"><br><img src="/images/incaseformat/%E7%97%85%E6%AF%92%E6%A0%B7%E4%BE%8B.png" alt="病毒样例"></p>
<h2 id="运行分析"><a href="#运行分析" class="headerlink" title="运行分析"></a>运行分析</h2><p>该病毒运行分两种情况，一种是在非Windows目录下执行时，不会对磁盘数据进行删除，它会将自身复制到Windows目录下，并创建RunOnce注册表开机启动。另外一种是在Windows目录下时，会将自身复制一份到同目录，并修改注册表中的数据将文件隐藏，随后<br>删除系统盘外的所有文件，在根目录留下一个incaseformat.log文件。<br><img src="/images/incaseformat/run.png" alt="运行分析1"><br><img src="/images/incaseformat/run1.png" alt="运行分析2"><br>为何病毒会在2021年1月13日运行？经过对该病毒逆向分析，原本是在2010年4月1日运行，但由程序中的日期转化与真实的主机日期不符合，导致时间转换为2021年1月13日。所以导致13日当天出现的大面积删除事件。<br><img src="/images/incaseformat/%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4.png" alt="运行时间"></p>
<h2 id="补救措施"><a href="#补救措施" class="headerlink" title="补救措施"></a>补救措施</h2><p>被删除文件后，千万别对被删数据磁盘进行写操作，因为数据被删除后没有真正的删除，只是把那个区域标志为闲置区域，但是数据还是在的。可找数据恢复专业人员进行补救，若自己了解数据恢复相关操作，也可以自己用软件进行恢复。</p>
]]></content>
      <categories>
        <category>木马病毒</category>
      </categories>
      <tags>
        <tag>病毒</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux远程连接windows</title>
    <url>/2021/01/13/linux-windows/</url>
    <content><![CDATA[<p>最近有个项目，需要远程连接windows 10版本，执行命令并返回。刚开始想的用winexe去做，但是winexe只支持smbv1版本的协议，大部分windows 10已经是smbv2及更高。碰巧的是，闲逛github的时候居然找到一位<a href="https://github.com/jborean93/pypsexec">国外小哥</a>实现好的功能，这这这… 遂记录此文章。</p>
<a id="more"></a>
<h2 id="安装pypsexec"><a href="#安装pypsexec" class="headerlink" title="安装pypsexec"></a>安装pypsexec</h2><p>联网的情况下直接用pip安装</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install pypsexec</span><br></pre></td></tr></table></figure>
<p>没网的小伙伴可依次下载pyspnego、smbprotocol、pypsexec，进入目录执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<h2 id="连接操作"><a href="#连接操作" class="headerlink" title="连接操作"></a>连接操作</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pypsexec.client <span class="keyword">import</span> Client</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd_line</span>(<span class="params">host, username, password, cmd</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 创立连接</span></span><br><span class="line">        c = Client(hostname=host, username=username, password=password)</span><br><span class="line">        <span class="comment"># 连接smbv1版本的机器可以将encrypt选项设置false</span></span><br><span class="line">        <span class="comment"># c = Client(hostname=host, username=username, password=password,encrypt=False)</span></span><br><span class="line">        <span class="comment"># 设置超时时间</span></span><br><span class="line">        c.connect(timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="comment"># 创建服务</span></span><br><span class="line">        c.create_service()</span><br><span class="line">        cmd = cmd</span><br><span class="line">        <span class="comment"># 执行cmd命令并返回结果</span></span><br><span class="line">        stdout, stderr, rc = c.run_executable(<span class="string">&quot;cmd.exe&quot;</span>,</span><br><span class="line">                                            arguments= <span class="string">&quot;/c &quot;</span> + cmd)</span><br><span class="line">        recv = stdout.decode()</span><br><span class="line">        print(recv)</span><br><span class="line">        <span class="comment"># 关闭连接</span></span><br><span class="line">        c.remove_service()</span><br><span class="line">        c.disconnect()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;hostname&quot;</span></span><br><span class="line">    username = <span class="string">&quot;username&quot;</span></span><br><span class="line">    password = <span class="string">&quot;password&quot;</span></span><br><span class="line">    cmd = <span class="string">&quot;whoami&quot;</span></span><br><span class="line">    cmd_line(host, username, password, cmd)</span><br></pre></td></tr></table></figure>
<p>其中host为目标ip，username和password对应目标用户名和密码，cmd为要执行的命令。</p>
<h3 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h3><p><img src="/images/linux-windows/1.results.png" alt="results1"><br><img src="/images/linux-windows/2.results.png" alt="results2"></p>
<h2 id="错误提示"><a href="#错误提示" class="headerlink" title="错误提示"></a>错误提示</h2><h3 id="错误1："><a href="#错误1：" class="headerlink" title="错误1："></a>错误1：</h3><p><img src="/images/linux-windows/1.error.png" alt="error1"><br>该错误是由于用户名或密码错误导致。</p>
<h3 id="错误2："><a href="#错误2：" class="headerlink" title="错误2："></a>错误2：</h3><p><img src="/images/linux-windows/2.error.png" alt="error2"><br>该错误是由于目标防火墙或UCA没关，需要关闭目标主机防火墙并在powershell上执行以下命令：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$reg_path</span> = <span class="string">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot;</span></span><br><span class="line"><span class="variable">$reg_prop_name</span> = <span class="string">&quot;LocalAccountTokenFilterPolicy&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$reg_key</span> = <span class="built_in">Get-Item</span> <span class="literal">-Path</span> <span class="variable">$reg_path</span></span><br><span class="line"><span class="variable">$reg_prop</span> = <span class="variable">$reg_key</span>.GetValue(<span class="variable">$reg_prop_name</span>)</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$reg_prop</span>) &#123;</span><br><span class="line">    <span class="built_in">Remove-ItemProperty</span> <span class="literal">-Path</span> <span class="variable">$reg_path</span> <span class="literal">-Name</span> <span class="variable">$reg_prop_name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="variable">$reg_path</span> <span class="literal">-Name</span> <span class="variable">$reg_prop_name</span> <span class="literal">-Value</span> <span class="number">1</span> <span class="literal">-PropertyType</span> DWord</span><br><span class="line"></span><br><span class="line"><span class="variable">$reg_path</span> = <span class="string">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot;</span></span><br><span class="line"><span class="variable">$reg_prop_name</span> = <span class="string">&quot;EnableLUA&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$reg_key</span> = <span class="built_in">Get-Item</span> <span class="literal">-Path</span> <span class="variable">$reg_path</span></span><br><span class="line"><span class="variable">$reg_prop</span> = <span class="variable">$reg_key</span>.GetValue(<span class="variable">$reg_prop_name</span>)</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$null</span> <span class="operator">-ne</span> <span class="variable">$reg_prop</span>) &#123;</span><br><span class="line">    <span class="built_in">Remove-ItemProperty</span> <span class="literal">-Path</span> <span class="variable">$reg_path</span> <span class="literal">-Name</span> <span class="variable">$reg_prop_name</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">New-ItemProperty</span> <span class="literal">-Path</span> <span class="variable">$reg_path</span> <span class="literal">-Name</span> <span class="variable">$reg_prop_name</span> <span class="literal">-Value</span> <span class="number">0</span> <span class="literal">-PropertyType</span> DWord</span><br></pre></td></tr></table></figure>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>如果目标主机使用的不是smbv2版本，建议优先使用winexe远程连接执行命令，使用该模块需要操作的步骤有点多。</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>安全开发</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>获取IPV4/IPV6主机snmp信息</title>
    <url>/2021/01/30/snmp/</url>
    <content><![CDATA[<p>snmp指的是简单网络管理协议，属于应用层协议，主要提供监控和管理网络设备的系统方法。一般通过snmp获取目标主机信息。</p>
<a id="more"></a>
<p>获取snmp信息需要利用snmpwalk，snmwalk是snmp的一个工具，通过指定oid可以远程获取snmp信息。</p>
<h2 id="snmp安装"><a href="#snmp安装" class="headerlink" title="snmp安装"></a>snmp安装</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum -y install net-snmp*</span><br><span class="line"></span><br><span class="line">cd /etc/snmp</span><br><span class="line"></span><br><span class="line">vi snmpd.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在文件最后一行添加以下信息,需要哪个就添加哪个,不用全部添加</span></span><br><span class="line">rwcommunity public # 设置snmp支持ipv4</span><br><span class="line">rwcommunity6 public # 设置snmp支持ipv6</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 退出文件编辑执行以下命令</span></span><br><span class="line">snmpd udp6:161 </span><br><span class="line"></span><br><span class="line">service snmpd restart</span><br></pre></td></tr></table></figure>
<p>以上命令执行完后，就可以执行snmpwalk了。</p>
<h2 id="snmpwalk使用"><a href="#snmpwalk使用" class="headerlink" title="snmpwalk使用"></a>snmpwalk使用</h2><p>常用snmpwalk命令格式为</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip oid</span><br></pre></td></tr></table></figure>
<p>-c : snmp团体名  一般为public<br>-v : 指定snmp版本  1|2c|3 现在大部分都是2c<br>ip : 目标ipv4或ipv6地址<br>oid : 具体oid号</p>
<p>此外还有以下常用参数：<br>-r : 指定连接次数<br>-t : 指定超时时间</p>
<h3 id="获取目标端口信息"><a href="#获取目标端口信息" class="headerlink" title="获取目标端口信息"></a>获取目标端口信息</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.2.1.6.13.1.3</span><br></pre></td></tr></table></figure>
<h3 id="获取目标系统基本信息"><a href="#获取目标系统基本信息" class="headerlink" title="获取目标系统基本信息"></a>获取目标系统基本信息</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.2.1.1.1.0</span><br></pre></td></tr></table></figure>
<h3 id="获取目标机器名"><a href="#获取目标机器名" class="headerlink" title="获取目标机器名"></a>获取目标机器名</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.2.1.1.5.0</span><br></pre></td></tr></table></figure>
<h3 id="获取系统cpu百分百"><a href="#获取系统cpu百分百" class="headerlink" title="获取系统cpu百分百"></a>获取系统cpu百分百</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.4.1.2021.11.11.0</span><br></pre></td></tr></table></figure>
<h3 id="获取安装软件目录"><a href="#获取安装软件目录" class="headerlink" title="获取安装软件目录"></a>获取安装软件目录</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.2.1.25.6.3.1.2</span><br></pre></td></tr></table></figure>
<h3 id="获取存储设备信息"><a href="#获取存储设备信息" class="headerlink" title="获取存储设备信息"></a>获取存储设备信息</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.2.1.25.2.3.1.3</span><br></pre></td></tr></table></figure>
<h3 id="获取服务和进程列表"><a href="#获取服务和进程列表" class="headerlink" title="获取服务和进程列表"></a>获取服务和进程列表</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.2.1.25.4.2.1.2</span><br></pre></td></tr></table></figure>
<h3 id="获取路由表"><a href="#获取路由表" class="headerlink" title="获取路由表"></a>获取路由表</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.2.1.4.21</span><br></pre></td></tr></table></figure>
<h3 id="获取网络接口"><a href="#获取网络接口" class="headerlink" title="获取网络接口"></a>获取网络接口</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">snmpwalk -c public -v 2c ip 1.3.6.1.2.1.2.2.1.2</span><br></pre></td></tr></table></figure>
<p><strong>注：若需要使用ipv6获取目标数据，将ip改为ipv6格式即可</strong><br><img src="/images/snmp/ipv6.png" alt="ipv6"></p>
<h2 id="python获取snmp信息"><a href="#python获取snmp信息" class="headerlink" title="python获取snmp信息"></a>python获取snmp信息</h2><p>既然是获取目标主机信息，怎么少的了python😎。</p>
<h3 id="安装pysnmp包"><a href="#安装pysnmp包" class="headerlink" title="安装pysnmp包"></a>安装pysnmp包</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install pysnmp</span><br></pre></td></tr></table></figure>
<p>没网的情况下需要下载pycryptodomex和pysnmp安装包，并分别进入目录运行。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><p>这里直接用写好的模板，详情请参考<a href="https://github.com/etingof/pysnmp">pysnmp</a>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pysnmp.hlapi <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">iterator = getCmd(SnmpEngine(),</span><br><span class="line">                  CommunityData(<span class="string">&#x27;public&#x27;</span>),</span><br><span class="line">                  UdpTransportTarget((<span class="string">&#x27;10.11.29.4&#x27;</span>, <span class="number">161</span>)),</span><br><span class="line">                  ContextData(),</span><br><span class="line">                  ObjectType(ObjectIdentity(<span class="string">&#x27;SNMPv2-MIB&#x27;</span>, <span class="string">&#x27;sysDescr&#x27;</span>, <span class="number">0</span>)))</span><br><span class="line"></span><br><span class="line">errorIndication, errorStatus, errorIndex, varBinds = <span class="built_in">next</span>(iterator)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> errorIndication:  <span class="comment"># SNMP engine errors</span></span><br><span class="line">    print(errorIndication)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> errorStatus:  <span class="comment"># SNMP agent errors</span></span><br><span class="line">        print(<span class="string">&#x27;%s at %s&#x27;</span> % (errorStatus.prettyPrint(), varBinds[<span class="built_in">int</span>(errorIndex)-<span class="number">1</span>] <span class="keyword">if</span> errorIndex <span class="keyword">else</span> <span class="string">&#x27;?&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> varBind <span class="keyword">in</span> varBinds:  <span class="comment"># SNMP response contents</span></span><br><span class="line">            print(<span class="string">&#x27; = &#x27;</span>.join([x.prettyPrint() <span class="keyword">for</span> x <span class="keyword">in</span> varBind]))</span><br></pre></td></tr></table></figure>
<p>CommunityData指定团体名。<br>UdpTransportTarget指定目标ip和端口。<br>ObjectType可以指定oid，也可以指定名称，具体可跟进ObjectIdentity查看示例。<br><img src="/images/snmp/%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C.png" alt="运行结果"></p>
<p>如果需要使用ipv6的话，引入Udp6TransportTarget，其它内容保持不变。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pysnmp.hlapi <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pysnmp.hlapi.asyncore <span class="keyword">import</span> Udp6TransportTarget</span><br><span class="line">iterator = getCmd(SnmpEngine(),</span><br><span class="line">                  CommunityData(<span class="string">&#x27;public&#x27;</span>),</span><br><span class="line">                  Udp6TransportTarget((<span class="string">&#x27;ipv6address&#x27;</span>, <span class="number">161</span>)),</span><br><span class="line">                  ContextData(),</span><br><span class="line">                  ObjectType(ObjectIdentity(<span class="string">&#x27;SNMPv2-MIB&#x27;</span>, <span class="string">&#x27;sysDescr&#x27;</span>, <span class="number">0</span>)))</span><br><span class="line"></span><br><span class="line">errorIndication, errorStatus, errorIndex, varBinds = <span class="built_in">next</span>(iterator)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> errorIndication:  <span class="comment"># SNMP engine errors</span></span><br><span class="line">    print(errorIndication)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> errorStatus:  <span class="comment"># SNMP agent errors</span></span><br><span class="line">        print(<span class="string">&#x27;%s at %s&#x27;</span> % (errorStatus.prettyPrint(), varBinds[<span class="built_in">int</span>(errorIndex)-<span class="number">1</span>] <span class="keyword">if</span> errorIndex <span class="keyword">else</span> <span class="string">&#x27;?&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> varBind <span class="keyword">in</span> varBinds:  <span class="comment"># SNMP response contents</span></span><br><span class="line">            print(<span class="string">&#x27; = &#x27;</span>.join([x.prettyPrint() <span class="keyword">for</span> x <span class="keyword">in</span> varBind]))</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>主机信息收集</category>
      </categories>
      <tags>
        <tag>安全开发</tag>
        <tag>Python</tag>
      </tags>
  </entry>
</search>
